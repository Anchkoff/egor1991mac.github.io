{"version":3,"file":"bundle.min.js","sources":["../src/core/Polyfill.ts"],"sourcesContent":["import Options from './Options';\n\nexport default class Polyfill {\n\tprivate options: Options;\n\tprivate parser: HTMLAnchorElement;\n\tprivate observer: MutationObserver;\n\tprivate process: boolean;\n\tprivate cache: {\n\t\tfiles: Map<string, HTMLElement|null>;\n\t\telements: Map<SVGUseElement, string>;\n\t};\n\tprivate handler: {\n\t\tviewportChange: EventListener;\n\t\tdocumentChange: MutationCallback;\n\t};\n\n\tprivate defaults: Options = {\n\t\ttarget: 'svg use',\n\t\tcontext: window.document.body || window.document.documentElement,\n\t\troot: window.document.body || window.document.documentElement,\n\t\trun: true,\n\t\tprefix: true,\n\t\tdetect: true,\n\t\tobserve: true,\n\t\tcrossdomain: true,\n\t\tnamespace: 'external-svg-polyfill',\n\t\tagents: [\n\t\t\t/msie|trident/i,\n\t\t\t/edge\\/12/i,\n\t\t\t/ucbrowser\\/11/i,\n\t\t],\n\t};\n\n\tpublic constructor(options?: Options) {\n\t\tthis.options = {\n\t\t\t...this.defaults,\n\t\t\t...options,\n\t\t};\n\n\t\tthis.cache = {\n\t\t\tfiles: new Map(),\n\t\t\telements: new Map(),\n\t\t};\n\n\t\tthis.handler = {\n\t\t\tviewportChange: this.onViewportChange.bind(this),\n\t\t\tdocumentChange: this.onDocumentChanged.bind(this),\n\t\t};\n\n\t\tthis.observer = new MutationObserver(this.handler.documentChange);\n\t\tthis.parser = window.document.createElement('a');\n\n\t\tthis.process = !this.options.detect || this.detect();\n\t\tthis.options.run && this.run();\n\t}\n\n\tpublic run(): void {\n\t\tthis.updateElements();\n\t\tthis.options.observe && this.observe();\n\t}\n\n\tpublic detect(): boolean {\n\t\treturn this.options.agents.some((agent: RegExp) => agent.test(window.navigator.userAgent));\n\t}\n\n\tpublic observe(): void {\n\t\tthis.observer.observe(this.options.context, {\n\t\t\tchildList: true,\n\t\t\tsubtree: true,\n\t\t});\n\n\t\twindow.addEventListener('resize', this.handler.viewportChange);\n\t\twindow.addEventListener('orientationchange', this.handler.viewportChange);\n\t}\n\n\tpublic unobserve(): void {\n\t\tthis.observer.disconnect();\n\n\t\twindow.removeEventListener('resize', this.handler.viewportChange);\n\t\twindow.removeEventListener('orientationchange', this.handler.viewportChange);\n\t}\n\n\tpublic destroy(): void {\n\t\tthis.unobserve();\n\n\t\tthis.cache.elements.forEach((value, element) => {\n\t\t\tthis.dispatchEvent(element, 'revoke', { value }, () => {\n\t\t\t\tthis.renderFrame(() => {\n\t\t\t\t\tthis.setLinkAttribute(element, value);\n\t\t\t\t\tthis.cache.elements.delete(element);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tthis.cache.files.forEach((file, address) => {\n\t\t\tfile && this.dispatchEvent(file, 'remove', { address }, () => {\n\t\t\t\tthis.renderFrame(() => this.options.root.removeChild(file));\n\t\t\t\tthis.cache.files.delete(address);\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate updateElements(): void {\n\t\tconst elements = typeof this.options.target === 'string'\n\t\t\t? [].slice.call(this.options.context.querySelectorAll(this.options.target))\n\t\t\t: this.options.target;\n\n\t\tArray.from(elements).forEach(this.processElement.bind(this));\n\t}\n\n\tprivate processElement(element: SVGUseElement): void {\n\t\tconst value = element.getAttribute('href') || element.getAttribute('xlink:href');\n\n\t\tif (value && !value.startsWith('#') && !this.cache.elements.has(element)) {\n\t\t\tthis.parser.href = value;\n\n\t\t\tif (this.process || (this.options.crossdomain && window.location.origin !== this.parser.origin)) {\n\t\t\t\tconst address = this.parser.href.split('#')[0];\n\t\t\t\tconst identifier = this.generateIdentifier(this.parser.hash, this.parser.pathname);\n\n\t\t\t\tif (address && !this.cache.files.has(address)) {\n\t\t\t\t\tthis.dispatchEvent(element, 'load', { address }, () => {\n\t\t\t\t\t\tthis.cache.files.set(address, null);\n\t\t\t\t\t\tthis.loadFile(address);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis.dispatchEvent(element, 'apply', { address, identifier }, () => {\n\t\t\t\t\tthis.renderFrame(() => {\n\t\t\t\t\t\tthis.setLinkAttribute(element, `#${identifier}`);\n\t\t\t\t\t\tthis.cache.elements.set(element, value);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate loadFile(address: string): void {\n\t\tconst loader = new XMLHttpRequest();\n\t\tloader.addEventListener('load', (event: Event) => this.onFileLoaded.call(this, event, address));\n\t\tloader.open('get', address);\n\t\tloader.responseType = 'document';\n\t\tloader.send();\n\t}\n\n\tprivate generateIdentifier(identifier: string, prefix: string): string {\n\t\tidentifier = identifier.replace('#', '');\n\t\tprefix = prefix.replace(/^\\//, '').replace(/\\.svg$/, '').replace(/[^a-zA-Z0-9]/g, '-');\n\n\t\treturn this.options.prefix\n\t\t\t? `${prefix}-${identifier}`\n\t\t\t: identifier;\n\t}\n\n\tprivate dispatchEvent(element: Element, name: string, detail?: any, callback?: Function): void {\n\t\tconst event = window.document.createEvent('CustomEvent');\n\t\tevent.initCustomEvent(`${this.options.namespace}.${name}`, true, true, detail);\n\n\t\telement.dispatchEvent(event);\n\n\t\tif (!event.defaultPrevented && callback) {\n\t\t\tcallback();\n\t\t}\n\t}\n\n\tprivate renderFrame(callback: FrameRequestCallback): void {\n\t\twindow.requestAnimationFrame(callback.bind(this));\n\t}\n\n\tprivate setLinkAttribute(element: SVGUseElement, value: string): void {\n\t\telement.hasAttribute('href') && element.setAttribute('href', value);\n\t\telement.hasAttribute('xlink:href') && element.setAttribute('xlink:href', value);\n\t}\n\n\tprivate prefixValues(file: HTMLElement, prefix: string): void {\n\t\t[].slice.call(file.querySelectorAll('[id]')).forEach((reference: HTMLElement) => {\n\t\t\tconst value = reference.getAttribute('id')!;\n\t\t\tconst identifier = this.generateIdentifier(value, prefix);\n\n\t\t\treference.setAttribute('id', identifier);\n\n\t\t\t[].slice.call(file.querySelectorAll(`[fill=\"url(#${value})\"]`)).forEach((referencee: HTMLElement) => {\n\t\t\t\treferencee.setAttribute('fill', `url(#${identifier})`);\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate onDocumentChanged(): void {\n\t\tthis.updateElements();\n\t}\n\n\tprivate onViewportChange(): void {\n\t\tthis.updateElements();\n\t}\n\n\tprivate onFileLoaded(event: Event, address: string): void {\n\t\tconst file = (event.target as XMLHttpRequest).response.documentElement;\n\t\tfile.setAttribute('aria-hidden', 'true');\n\t\tfile.style.position = 'absolute';\n\t\tfile.style.overflow = 'hidden';\n\t\tfile.style.width = 0;\n\t\tfile.style.height = 0;\n\n\t\tthis.cache.files.set(address, file);\n\n\t\tif (this.options.prefix) {\n\t\t\tthis.parser.href = address;\n\t\t\tthis.prefixValues(file, this.parser.pathname);\n\t\t}\n\n\t\tthis.dispatchEvent(this.options.root, 'insert', { address, file }, () => {\n\t\t\tthis.renderFrame(() => {\n\t\t\t\tthis.options.root.insertAdjacentElement('afterbegin', file);\n\t\t\t});\n\t\t});\n\t}\n}\n"],"names":["options","this","target","context","window","document","body","documentElement","root","run","prefix","detect","observe","crossdomain","namespace","agents","defaults","cache","files","Map","elements","handler","viewportChange","onViewportChange","bind","documentChange","onDocumentChanged","observer","MutationObserver","parser","createElement","process","Polyfill","updateElements","some","agent","test","navigator","userAgent","childList","subtree","addEventListener","disconnect","removeEventListener","unobserve","forEach","value","element","_this","dispatchEvent","renderFrame","setLinkAttribute","delete","file","address","removeChild","slice","call","querySelectorAll","Array","from","processElement","getAttribute","startsWith","has","href","location","origin","address_1","split","identifier_1","generateIdentifier","hash","pathname","set","loadFile","identifier","loader","XMLHttpRequest","event","onFileLoaded","open","responseType","send","replace","name","detail","callback","createEvent","initCustomEvent","defaultPrevented","requestAnimationFrame","hasAttribute","setAttribute","reference","referencee","response","style","position","overflow","width","height","prefixValues","insertAdjacentElement"],"mappings":"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"}